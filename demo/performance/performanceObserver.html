<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>performanceObserver</title>
    <style>
        body {
            /* æ³¨æ„ï¼šç™½è‰²èƒŒæ™¯è‰²ä¸ç®—FP */
            background-color: ghostwhite;
        }
    </style>
    <script defer src='./defer.js'></script>
    <script type='module'>
        console.warn('-----------module script: DOMContentLoadedäº‹ä»¶è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œä½†æ˜¯domå·²ç»å®Œæˆ', document.readyState, 'é˜¶æ®µ');
    </script>
    <script>
        var headEnding = +new Date;
    </script>
    <script src="./fps.js"></script>
    <script>
        window.onerror = function(e) {
            alert('err')
            console.log(e)
        }
    </script>
</head>
<body>
    <div id='root'>FCP ç›‘å¬çš„é¦–æ¬¡ç»˜åˆ¶å†…å®¹</div>
    <script src='./async.js'></script>
    <script>
        try {
            alert(2);
            null.a = 1
        } catch (error) {
            alert(1);
            console.error(error);
        }
    </script>
    <script>
        // PerformanceObserver ç”¨äºç›‘æµ‹æ€§èƒ½åº¦é‡äº‹ä»¶ï¼Œåœ¨æµè§ˆå™¨çš„æ€§èƒ½æ—¶é—´è½´è®°å½•ä¸‹ä¸€ä¸ªæ–°çš„ performance entries  çš„æ—¶å€™å°†ä¼šè¢«é€šçŸ¥
        // åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ PerformanceObserver å¯¹è±¡
        const observerPaint = new PerformanceObserver(
            (list, observer) => {
                for (const entry of list.getEntries()) {
                    console.group('PerformanceObserver-paint:', entry.name);
                    console.log(entry);
                    console.log('ç±»å‹ğŸš€', entry.entryType);
                    console.log('å…·ä½“æŒ‡æ ‡ğŸš€', entry.name);
                    console.log('å¼€å§‹æ—¶é—´â°', entry.startTime);
                    console.log('durationâŒšï¸', entry.duration);
                    console.groupEnd();
                }
                observerPaint.disconnect();
            }
        );
        // observerPaint.observe({ entryTypes: ['paint'] });
        /* FMP */
        const observerMark = new PerformanceObserver(
            (list, observer) => {
                for (const entry of list.getEntries()) {
                    console.group('PerformanceObserver-mark:', entry.name);
                    console.log(entry);
                    console.log('ç±»å‹ğŸš€', entry.entryType);
                    console.log('å…·ä½“æŒ‡æ ‡ğŸš€', entry.name);
                    console.log('å¼€å§‹æ—¶é—´â°', entry.startTime);
                    console.log('durationâŒšï¸', entry.duration);
                    console.groupEnd();
                }
                performance.clearMarks('FMP');
                observerMark.disconnect();
            }
        );
        observerMark.observe({ entryTypes: ['mark'] });


        /* Long Task éœ€è¦åœ¨jsè„šæœ¬å‰ç½®æ‰èƒ½æ£€æµ‹åˆ° */
        const observerLongtask = new PerformanceObserver(
            (list) => {
                for (const entry of list.getEntries()) {
                    console.group('PerformanceObserver-longtask:', entry.name);
                    console.log(entry);
                    console.error('ç±»å‹ğŸš€', entry.entryType);
                    console.log('å…·ä½“æŒ‡æ ‡ğŸš€', entry.name);
                    console.log('å¼€å§‹æ—¶é—´â°', entry.startTime);
                    console.log('durationâŒšï¸', entry.duration);
                    console.log(entry.attribution);
                    console.groupEnd();
                }
                observerLongtask.disconnect();
            }
        );
        // observerLongtask.observe({ entryTypes: ['longtask'] });

    </script>
    <script>
        var ending1 = +new Date;
    </script>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <script>
        var ending2 = +new Date;
        function longtaskFun(params) {
            let x = 0;
            for (let index = 0; index < 10000000; index++) {
                x++;
            }
        }
        longtaskFun();
        console.warn('-----script parser end-----, domInteractive is ', performance.timing.domInteractive);
    </script>
    <script>
        // æ¨¡æ‹ŸcomponentDidMound fetch
        setTimeout(() => {
            // æ•°æ®å›æ¥åè¿›è¡Œæ—¶é—´ç‚¹æ ‡è®°
            performance.mark('FMP');
        }, 200);
    </script>
    <script src="./tti-polyfill.js"></script>
    <script>
        console.warn('ç½‘ç»œå¾€è¿”æ—¶å»¶â°', navigator.connection.rtt);

        // for (const entry of performance.getEntriesByType('paint')) {
        //     console.group('PerformanceObserver-paint:', entry.name);
        //     console.log(entry);
        //     console.log('ç±»å‹ğŸš€', entry.entryType);
        //     console.log('å…·ä½“æŒ‡æ ‡ğŸš€', entry.name);
        //     console.log('å¼€å§‹æ—¶é—´â°', entry.startTime);
        //     console.log('durationâŒšï¸', entry.duration);
        //     console.groupEnd();
        // }

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('--------DOMContentLoaded--------', performance.now())
        });

        document.addEventListener('readystatechange', (event) => {
            const {
                navigationStart,
                domLoading,
                domInteractive,
                domContentLoadedEventStart,
                domContentLoadedEventEnd,
                domComplete,
            } = performance.timing;
            // console.group('addEventListener-readystatechange:', document.readyState, performance.now());
            // console.log('domLoading', domLoading - navigationStart);
            // console.log('domInteractive', domInteractive - navigationStart);
            // console.log('domContentLoadedEventStart', domContentLoadedEventStart - navigationStart);
            // console.log('domContentLoadedEventEnd', domContentLoadedEventEnd - navigationStart);
            // console.log('domComplete', domComplete - navigationStart);
            // console.log('headæ ‡ç­¾ç»“æŸ', window.headEnding - navigationStart);
            // console.log('jså¤–é“¾åŒæ­¥è„šæœ¬æ‰§è¡Œå‰', window.ending1 - navigationStart);
            // console.log('jså¤–é“¾åŒæ­¥è„šæœ¬æ‰§è¡Œå', window.ending2 - navigationStart);
            // console.log('æ‰€æœ‰åŒæ­¥è„šæœ¬æ‰§è¡Œå®Œæ¯•', window.ending3 - navigationStart);
            // console.groupEnd();

            if (document.readyState === 'complete') {
                for (const entry of performance.getEntriesByType('resource')) {
                    console.group('PerformanceObserver-resource:', entry.name);
                    console.log(entry);
                    console.log('ç±»å‹ğŸš€', entry.entryType);
                    console.log('å…·ä½“æŒ‡æ ‡ğŸš€', entry.name);
                    console.log('å¼€å§‹æ—¶é—´â°', entry.startTime);
                    console.log('durationâŒšï¸', entry.duration);
                    console.log('transferSizeğŸ“Œ', entry.transferSize, 'B');
                    console.log('encodedBodySizeğŸ“Œ', entry.encodedBodySize, 'B');
                    console.log('initiatorType', entry.initiatorType);
                    console.groupEnd();
                }

                // jsHeapSizeLimit
                // ä¸Šä¸‹æ–‡å†…å¯ç”¨å †çš„æœ€å¤§ä½“ç§¯ï¼Œä»¥å­—èŠ‚è®¡ç®—ã€‚
                // totalJSHeapSize
                // å·²åˆ†é…çš„å †ä½“ç§¯ï¼Œä»¥å­—èŠ‚è®¡ç®—ã€‚
                // usedJSHeapSize
                // å½“å‰ JS å †æ´»è·ƒæ®µï¼ˆsegmentï¼‰çš„ä½“ç§¯ï¼Œä»¥å­—èŠ‚è®¡ç®—ã€‚
                const {
                    totalJSHeapSize,
                    usedJSHeapSize,
                } = performance.memory;
                console.log('jså†…å­˜ä½¿ç”¨å æ¯” ï¼š' + (usedJSHeapSize / totalJSHeapSize * 100).toFixed(2) + '%')
            }
        });

        ttiPolyfill.getFirstConsistentlyInteractive().then((tti) => {
            console.warn('ç”¨æˆ·å¯äº¤äº’æ—¶é—´tti ğŸ¦ğŸ¦', tti);
        });

        var ending3 = +new Date;
    </script>
</body>
</html>